## 蓝牙
### LED灯状态

大致分为从模式和主模式



### 工作模式


1.AT指令模式





2.数据透传模式



### 硬件连接

1.蓝牙模块与开发板的实物连接



2.蓝牙模块与开发板的原理图连接





注：
clear引脚接高电平，在主机模式下用来清除已记录的从机地址。

3.问题汇总
1）检查蓝牙模块硬件正常工作
2）发送和接收引脚已经连接正确
3）串口3的跳线帽连接正确

4）检查代码的PLL有没有问题，串口的程序是否正确
5）部分同学的手机存在兼容性问题，微信小程序无法搜索，解决方案如下：
一般最好使用大众化的手机：小米、华为、iPhone、oppo、vivo。
若是安卓手机，且使用版本为Android10或以上，打开蓝牙的同时必须打开GPS。 


### AT指令程序设计

1.设置模块的名字
```c
void usart3_send_str(const char *pbuf)
{
    const char *p = pbuf;
    
  	//检测当前p的指针有效性
	//*p检测是否为非0  
	while(p && *p)
	{
		USART_SendData(USART3,*p++);
		while(USART_GetFlagStatus(USART3,USART_FLAG_TXE)==RESET);
	}
}
void ble_set_config(void)
{
	//设置好模块的名字
	usart3_send_str("AT+NAMETeacher.Wen\r\n");
	delay_ms(500);

	//获取模块的地址信息，因为通过手机搜索的时候，
   //使用提供的APK，有些时候无法显示到模块的名字，只能显示到模块的地址信息
	usart3_send_str("AT+LADDR\r\n");
	delay_ms(500);
 
   //重新启动模块
 	usart3_send_str("AT+RESET\r\n");
	delay_ms(2000);
}
```
2.编译代码并下载程序到开发板,在PC的串口调试助手看到以下信息


3.复位蓝牙模块，可以使用以下两种方法
方法1：发送"AT+RESET\r\n"指令
方法2：重新对蓝牙模块上电，即对蓝牙模块5V的引脚重新插拔！

重新刷新手机端的APP，搜索蓝牙模块。

4.通过手机去搜索蓝牙模块
  在手机上安装 <蓝牙调试器> 的软件（或者自己关注一个蓝牙调试的微信公众号）

打开微信，搜索“蓝牙串口”该小程序，操作如下：

下面几个常用的AT指令需要掌握
①测试：AT\r\n                                           返回：OK     （即通信成功）
②设置蓝牙名称：AT+NAME=PDD\r\n       返回：OK
③查询蓝牙名称：AT+NAME?\r\n              返回：+NAME=PDD   OK
④设置配对密码：AT+PSWD=1234\r\n      返回：OK
⑤查询配对密码：AT+PSWD?\r\n              返回：+PSWD=1234   OK
⑥查询设备mac地址：AT+ADDR?\r\n        返回：+ADDR:21:13:52b9b   OK

注：
如果不能够搜索到自己的蓝牙模块或者模块名字没有发生改变，
请对蓝牙发送AT+RESET或模块重新上电（重新插拔模块的供电引脚）。


思考题：通过PC转发数据给手机的时候，如何杜绝丢包的事情，有什么解决办法？
回答：
方法1：设置串口1的波特率等于串口3的波特率就可以了，缺点就是降低了串口1的波特率。
方法2：在串口1中断服务函数实现连续接收数据，接收数据完毕后才全部发送给串口3。

总结，方法2为最优的解决方案，且蓝牙模块收发一次数据包的大小不能超过20字节。

